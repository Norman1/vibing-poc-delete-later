<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plain Meaning Bible Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .book-selector {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .book-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
        }

        .book-selector select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .book-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .content {
            padding: 30px;
            text-align: left;
        }

        .book-title {
            font-size: 2.2em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        .chapter {
            margin-bottom: 40px;
            text-align: left;
        }

        .chapter-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            padding: 10px 0;
            border-left: 4px solid #667eea;
            padding-left: 20px;
            background: rgba(102, 126, 234, 0.05);
        }

        .section-title-main {
            font-size: 1.6em;
            color: #764ba2;
            margin: 30px 0 20px 0;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            border: 2px solid rgba(118, 75, 162, 0.2);
        }

        .section-title-sub {
            font-size: 1.3em;
            color: #555;
            margin: 20px 0 15px 0;
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.05);
            border-left: 3px solid #667eea;
            font-weight: 500;
        }

        .verse {
            margin-bottom: 15px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            transition: all 0.3s ease;
            text-align: left;
            display: block;
        }

        .verse:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .verse-number {
            font-weight: bold;
            color: #667eea;
            margin-right: 10px;
            font-size: 0.9em;
        }

        .verse-text {
            display: inline;
            font-size: 1.1em;
            line-height: 1.7;
        }

        .note {
            display: block;
            margin-top: 8px;
            padding: 8px 12px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            font-size: 0.9em;
            color: #856404;
            font-style: italic;
        }

        .note::before {
            content: "üìù ";
            margin-right: 5px;
        }

        .no-content {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            border-top: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Plain Meaning Bible</h1>
            <p>A meaning-driven translation using functional equivalence</p>
        </div>

        <div class="book-selector">
            <label for="bookSelect">Select a book to view:</label>
            <select id="bookSelect" onchange="loadBook()">
                <option value="">Choose a book...</option>
                <option value="dummy">Dummy (Sample)</option>
                <option value="genesis">Genesis</option>
                <option value="exodus">Exodus</option>
                <option value="leviticus">Leviticus</option>
                <option value="numbers">Numbers</option>
                <option value="deuteronomy">Deuteronomy</option>
                <option value="joshua">Joshua</option>
                <option value="judges">Judges</option>
                <option value="ruth">Ruth</option>
                <option value="1samuel">1 Samuel</option>
                <option value="2samuel">2 Samuel</option>
                <option value="1kings">1 Kings</option>
                <option value="2kings">2 Kings</option>
                <option value="1chronicles">1 Chronicles</option>
                <option value="2chronicles">2 Chronicles</option>
                <option value="ezra">Ezra</option>
                <option value="nehemiah">Nehemiah</option>
                <option value="esther">Esther</option>
                <option value="job">Job</option>
                <option value="psalms">Psalms</option>
                <option value="proverbs">Proverbs</option>
                <option value="ecclesiastes">Ecclesiastes</option>
                <option value="song">Song of Songs</option>
                <option value="isaiah">Isaiah</option>
                <option value="jeremiah">Jeremiah</option>
                <option value="lamentations">Lamentations</option>
                <option value="ezekiel">Ezekiel</option>
                <option value="daniel">Daniel</option>
                <option value="hosea">Hosea</option>
                <option value="joel">Joel</option>
                <option value="amos">Amos</option>
                <option value="obadiah">Obadiah</option>
                <option value="jonah">Jonah</option>
                <option value="micah">Micah</option>
                <option value="nahum">Nahum</option>
                <option value="habakkuk">Habakkuk</option>
                <option value="zephaniah">Zephaniah</option>
                <option value="haggai">Haggai</option>
                <option value="zechariah">Zechariah</option>
                <option value="malachi">Malachi</option>
                <option value="matthew">Matthew</option>
                <option value="mark">Mark</option>
                <option value="luke">Luke</option>
                <option value="john">John</option>
                <option value="acts">Acts</option>
                <option value="romans">Romans</option>
                <option value="1corinthians">1 Corinthians</option>
                <option value="2corinthians">2 Corinthians</option>
                <option value="galatians">Galatians</option>
                <option value="ephesians">Ephesians</option>
                <option value="philippians">Philippians</option>
                <option value="colossians">Colossians</option>
                <option value="1thessalonians">1 Thessalonians</option>
                <option value="2thessalonians">2 Thessalonians</option>
                <option value="1timothy">1 Timothy</option>
                <option value="2timothy">2 Timothy</option>
                <option value="titus">Titus</option>
                <option value="philemon">Philemon</option>
                <option value="hebrews">Hebrews</option>
                <option value="james">James</option>
                <option value="1peter">1 Peter</option>
                <option value="2peter">2 Peter</option>
                <option value="1john">1 John</option>
                <option value="2john">2 John</option>
                <option value="3john">3 John</option>
                <option value="jude">Jude</option>
                <option value="revelation">Revelation</option>
            </select>
        </div>

        <div class="content">
            <div id="book-content" class="no-content">
                Select a book from the dropdown above to view the translation.
            </div>
        </div>

        <div class="footer">
            <p>Public Domain ‚Ä¢ Functional Equivalence Translation</p>
        </div>
    </div>

    <script>
        const books = {
            'dummy': { title: 'Dummy (Sample)', file: 'output/00_dummy_vbt.osis.xml' },
            'genesis': { title: 'Genesis', file: 'output/01_genesis_vbt.osis.xml' },
            'exodus': { title: 'Exodus', file: 'output/02_exodus_vbt.osis.xml' },
            'leviticus': { title: 'Leviticus', file: 'output/03_leviticus_vbt.osis.xml' },
            'numbers': { title: 'Numbers', file: 'output/04_numbers_vbt.osis.xml' },
            'deuteronomy': { title: 'Deuteronomy', file: 'output/05_deuteronomy_vbt.osis.xml' },
            'joshua': { title: 'Joshua', file: 'output/06_joshua_vbt.osis.xml' },
            'judges': { title: 'Judges', file: 'output/07_judges_vbt.osis.xml' },
            'ruth': { title: 'Ruth', file: 'output/08_ruth_vbt.osis.xml' },
            '1samuel': { title: '1 Samuel', file: 'output/09_1samuel_vbt.osis.xml' },
            '2samuel': { title: '2 Samuel', file: 'output/10_2samuel_vbt.osis.xml' },
            '1kings': { title: '1 Kings', file: 'output/11_1kings_vbt.osis.xml' },
            '2kings': { title: '2 Kings', file: 'output/12_2kings_vbt.osis.xml' },
            '1chronicles': { title: '1 Chronicles', file: 'output/13_1chronicles_vbt.osis.xml' },
            '2chronicles': { title: '2 Chronicles', file: 'output/14_2chronicles_vbt.osis.xml' },
            'ezra': { title: 'Ezra', file: 'output/15_ezra_vbt.osis.xml' },
            'nehemiah': { title: 'Nehemiah', file: 'output/16_nehemiah_vbt.osis.xml' },
            'esther': { title: 'Esther', file: 'output/17_esther_vbt.osis.xml' },
            'job': { title: 'Job', file: 'output/18_job_vbt.osis.xml' },
            'psalms': { title: 'Psalms', file: 'output/19_psalms_vbt.osis.xml' },
            'proverbs': { title: 'Proverbs', file: 'output/20_proverbs_vbt.osis.xml' },
            'ecclesiastes': { title: 'Ecclesiastes', file: 'output/21_ecclesiastes_vbt.osis.xml' },
            'song': { title: 'Song of Songs', file: 'output/22_song_vbt.osis.xml' },
            'isaiah': { title: 'Isaiah', file: 'output/23_isaiah_vbt.osis.xml' },
            'jeremiah': { title: 'Jeremiah', file: 'output/24_jeremiah_vbt.osis.xml' },
            'lamentations': { title: 'Lamentations', file: 'output/25_lamentations_vbt.osis.xml' },
            'ezekiel': { title: 'Ezekiel', file: 'output/26_ezekiel_vbt.osis.xml' },
            'daniel': { title: 'Daniel', file: 'output/27_daniel_vbt.osis.xml' },
            'hosea': { title: 'Hosea', file: 'output/28_hosea_vbt.osis.xml' },
            'joel': { title: 'Joel', file: 'output/29_joel_vbt.osis.xml' },
            'amos': { title: 'Amos', file: 'output/30_amos_vbt.osis.xml' },
            'obadiah': { title: 'Obadiah', file: 'output/31_obadiah_vbt.osis.xml' },
            'jonah': { title: 'Jonah', file: 'output/32_jonah_vbt.osis.xml' },
            'micah': { title: 'Micah', file: 'output/33_micah_vbt.osis.xml' },
            'nahum': { title: 'Nahum', file: 'output/34_nahum_vbt.osis.xml' },
            'habakkuk': { title: 'Habakkuk', file: 'output/35_habakkuk_vbt.osis.xml' },
            'zephaniah': { title: 'Zephaniah', file: 'output/36_zephaniah_vbt.osis.xml' },
            'haggai': { title: 'Haggai', file: 'output/37_haggai_vbt.osis.xml' },
            'zechariah': { title: 'Zechariah', file: 'output/38_zechariah_vbt.osis.xml' },
            'malachi': { title: 'Malachi', file: 'output/39_malachi_vbt.osis.xml' },
            'matthew': { title: 'Matthew', file: 'output/40_matthew_vbt.osis.xml' },
            'mark': { title: 'Mark', file: 'output/41_mark_vbt.osis.xml' },
            'luke': { title: 'Luke', file: 'output/42_luke_vbt.osis.xml' },
            'john': { title: 'John', file: 'output/43_john_vbt.osis.xml' },
            'acts': { title: 'Acts', file: 'output/44_acts_vbt.osis.xml' },
            'romans': { title: 'Romans', file: 'output/45_romans_vbt.osis.xml' },
            '1corinthians': { title: '1 Corinthians', file: 'output/46_1corinthians_vbt.osis.xml' },
            '2corinthians': { title: '2 Corinthians', file: 'output/47_2corinthians_vbt.osis.xml' },
            'galatians': { title: 'Galatians', file: 'output/48_galatians_vbt.osis.xml' },
            'ephesians': { title: 'Ephesians', file: 'output/49_ephesians_vbt.osis.xml' },
            'philippians': { title: 'Philippians', file: 'output/50_philippians_vbt.osis.xml' },
            'colossians': { title: 'Colossians', file: 'output/51_colossians_vbt.osis.xml' },
            '1thessalonians': { title: '1 Thessalonians', file: 'output/52_1thessalonians_vbt.osis.xml' },
            '2thessalonians': { title: '2 Thessalonians', file: 'output/53_2thessalonians_vbt.osis.xml' },
            '1timothy': { title: '1 Timothy', file: 'output/54_1timothy_vbt.osis.xml' },
            '2timothy': { title: '2 Timothy', file: 'output/55_2timothy_vbt.osis.xml' },
            'titus': { title: 'Titus', file: 'output/56_titus_vbt.osis.xml' },
            'philemon': { title: 'Philemon', file: 'output/57_philemon_vbt.osis.xml' },
            'hebrews': { title: 'Hebrews', file: 'output/58_hebrews_vbt.osis.xml' },
            'james': { title: 'James', file: 'output/59_james_vbt.osis.xml' },
            '1peter': { title: '1 Peter', file: 'output/60_1peter_vbt.osis.xml' },
            '2peter': { title: '2 Peter', file: 'output/61_2peter_vbt.osis.xml' },
            '1john': { title: '1 John', file: 'output/62_1john_vbt.osis.xml' },
            '2john': { title: '2 John', file: 'output/63_2john_vbt.osis.xml' },
            '3john': { title: '3 John', file: 'output/64_3john_vbt.osis.xml' },
            'jude': { title: 'Jude', file: 'output/65_jude_vbt.osis.xml' },
            'revelation': { title: 'Revelation', file: 'output/66_revelation_vbt.osis.xml' }
        };

        function processOSISContent(element) {
            let html = '';
            
            // Process all child nodes
            for (let node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    html += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    switch(node.nodeName) {
                        case 'divineName':
                            html += `<span style="font-variant: small-caps;">${node.textContent}</span>`;
                            break;
                        case 'name':
                            html += `<span style="font-weight: bold;">${node.textContent}</span>`;
                            break;
                        case 'hi':
                            const hiType = node.getAttribute('type');
                            if (hiType === 'bold') {
                                html += `<strong>${node.textContent}</strong>`;
                            } else if (hiType === 'italic') {
                                html += `<em>${node.textContent}</em>`;
                            } else if (hiType === 'underline') {
                                html += `<u>${node.textContent}</u>`;
                            } else {
                                html += node.textContent;
                            }
                            break;
                        case 'note':
                            const noteType = node.getAttribute('type') || 'note';
                            html += `<sup style="color: #667eea;">[${noteType}]</sup>`;
                            break;
                        case 'reference':
                            html += `<a href="#" style="color: #667eea; text-decoration: none;">${node.textContent}</a>`;
                            break;
                        case 'foreign':
                            html += `<span style="font-style: italic;">${node.textContent}</span>`;
                            break;
                        case 'q':
                            const marker = node.getAttribute('marker');
                            if (marker) {
                                html += marker + processOSISContent(node) + marker;
                            } else {
                                html += '"' + processOSISContent(node) + '"';
                            }
                            break;
                        case 'w':
                            html += `<span class="word">${node.textContent}</span>`;
                            break;
                        case 'abbr':
                            const expansion = node.getAttribute('expansion');
                            html += `<abbr title="${expansion || ''}">${node.textContent}</abbr>`;
                            break;
                        case 'date':
                            html += `<span class="date">${node.textContent}</span>`;
                            break;
                        case 'milestone':
                            // Milestones are empty elements
                            break;
                        case 'seg':
                            html += `<span style="text-decoration: underline dotted;">${node.textContent}</span>`;
                            break;
                        case 'lb':
                            html += '<br/>';
                            break;
                        case 'transChange':
                            html += `<span style="font-style: italic;">${node.textContent}</span>`;
                            break;
                        case 'inscription':
                            html += `<span style="font-variant: small-caps; font-weight: bold;">${node.textContent}</span>`;
                            break;
                        case 'mentioned':
                            html += `<span style="font-style: italic;">"${node.textContent}"</span>`;
                            break;
                        case 'speaker':
                            html += `<strong>${node.textContent}:</strong>`;
                            break;
                        case 'catchWord':
                            html += `<span style="font-weight: bold; font-style: italic; background: #ffffcc; padding: 2px 4px;">${node.textContent}</span>`;
                            break;
                        case 'rdgGrp':
                            html += '<span style="background: #f0f8ff; border: 1px solid #ddd; padding: 2px; margin: 0 2px;">';
                            const readings = node.querySelectorAll('rdg');
                            readings.forEach((rdg, index) => {
                                if (index > 0) html += ' / ';
                                const rdgType = rdg.getAttribute('type') || 'reading';
                                html += `<span style="font-size: 0.9em; color: #666;">[${rdgType}]</span> ${rdg.textContent}`;
                            });
                            html += '</span>';
                            break;
                        case 'rdg':
                            // Skip individual rdg processing - handled by rdgGrp
                            break;
                        case 'milestoneStart':
                            const msType = node.getAttribute('type') || 'milestone';
                            const msN = node.getAttribute('n') || '';
                            html += `<span style="color: #999; font-size: 0.8em; border: 1px dotted #999; padding: 1px 3px;">[${msType} start${msN ? ' ' + msN : ''}]</span>`;
                            break;
                        case 'milestoneEnd':
                            const meType = node.getAttribute('type') || 'milestone';
                            html += `<span style="color: #999; font-size: 0.8em; border: 1px dotted #999; padding: 1px 3px;">[${meType} end]</span>`;
                            break;
                        case 'caption':
                            // Skip - handled by figure
                            break;
                        case 'figure':
                            const alt = node.getAttribute('alt');
                            const src = node.getAttribute('src');
                            const caption = node.querySelector('caption');
                            let figureContent = caption ? caption.textContent : (alt || 'Figure');
                            html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; text-align: center;">`;
                            if (src) {
                                html += `<div style="font-style: italic;">[Image: ${src}]</div>`;
                            }
                            html += `<div style="font-weight: bold;">${figureContent}</div></div>`;
                            break;
                        default:
                            html += processOSISContent(node);
                    }
                }
            }
            
            return html;
        }

        function processVerseContent(verseElement) {
            let verseHTML = processOSISContent(verseElement);
            
            // Add notes at the end
            const notes = verseElement.querySelectorAll('note');
            if (notes.length > 0) {
                verseHTML += '<div style="margin-top: 5px; font-size: 0.9em; color: #666;">';
                notes.forEach(note => {
                    const noteType = note.getAttribute('type') || 'note';
                    verseHTML += `<div style="margin: 2px 0;"><strong>${noteType}:</strong> ${note.textContent}</div>`;
                });
                verseHTML += '</div>';
            }
            
            return verseHTML;
        }

        function processMilestoneVerse(verseStartElement, startNode) {
            const verseId = verseStartElement.getAttribute('osisID');
            const verseNum = verseId ? verseId.split('.').pop() : '?';
            const verseEndId = verseStartElement.getAttribute('sID');
            
            let html = `<div class="verse">`;
            html += `<span class="verse-number">${verseNum}</span>`;
            html += `<span class="verse-text">`;
            
            // Collect all content between verse start and end markers
            let verseContent = '';
            let currentNode = startNode;
            
            while (currentNode) {
                if (currentNode.nodeType === Node.ELEMENT_NODE) {
                    if (currentNode.nodeName === 'verse' && currentNode.getAttribute('eID') === verseEndId) {
                        break; // Found the end marker
                    }
                    // Process the element
                    verseContent += processOSISContent(currentNode);
                } else if (currentNode.nodeType === Node.TEXT_NODE) {
                    verseContent += currentNode.textContent;
                }
                currentNode = currentNode.nextSibling;
            }
            
            html += verseContent;
            html += `</span></div>`;
            
            return html;
        }

        function processMilestoneVerseInContainer(verseStartElement, startIndex, children) {
            const verseId = verseStartElement.getAttribute('osisID');
            const verseNum = verseId ? verseId.split('.').pop() : '?';
            const verseEndId = verseStartElement.getAttribute('sID');
            
            let html = `<div class="verse">`;
            html += `<span class="verse-number">${verseNum}</span>`;
            html += `<span class="verse-text">`;
            
            // Collect all content between verse start and end markers from children array
            let verseContent = '';
            for (let i = startIndex + 1; i < children.length; i++) {
                const child = children[i];
                if (child.nodeName === 'verse' && child.getAttribute('eID') === verseEndId) {
                    break; // Found the end marker
                }
                // Process the element content
                verseContent += processOSISContent(child);
            }
            
            // Also check for text nodes between the elements
            let currentNode = verseStartElement.nextSibling;
            while (currentNode) {
                if (currentNode.nodeType === Node.ELEMENT_NODE) {
                    if (currentNode.nodeName === 'verse' && currentNode.getAttribute('eID') === verseEndId) {
                        break;
                    }
                    // Skip elements - they're handled above
                } else if (currentNode.nodeType === Node.TEXT_NODE) {
                    verseContent += currentNode.textContent;
                }
                currentNode = currentNode.nextSibling;
            }
            
            html += verseContent;
            html += `</span></div>`;
            
            return html;
        }

        function processChapterElement(element, chapterNum) {
            let html = '';
            
            switch(element.nodeName) {
                case 'head':
                    const headType = element.getAttribute('type') || '';
                    html += `<h3 style="margin: 15px 0; color: #34495e; font-size: 1.2em;">${element.textContent}</h3>`;
                    break;
                    
                case 'title':
                    const titleType = element.getAttribute('type') || '';
                    if (titleType === 'chapter') {
                        html += `<div class="chapter-title">Chapter ${chapterNum}</div>`;
                    } else if (titleType === 'sub' || titleType === 'parallel') {
                        html += `<div style="font-style: italic; margin: 10px 0; color: #666;">${element.textContent}</div>`;
                    } else {
                        html += `<h4 style="margin: 10px 0; color: #2c3e50;">${element.textContent}</h4>`;
                    }
                    break;
                    
                case 'p':
                    html += `<p style="margin: 10px 0;">${processOSISContent(element)}</p>`;
                    break;
                    
                case 'verse':
                    const verseId = element.getAttribute('osisID');
                    const sID = element.getAttribute('sID');
                    const eID = element.getAttribute('eID');
                    
                    if (sID) {
                        // This is a milestone verse start - skip it here, it will be handled by the parent
                        // milestone processing or we need to handle it specially
                        return '';
                    } else if (eID) {
                        // This is a milestone verse end - skip it
                        return '';
                    } else if (verseId) {
                        // This is a container verse
                        const verseNum = verseId.split('.').pop();
                        html += `<div class="verse">`;
                        html += `<span class="verse-number">${verseNum}</span>`;
                        html += `<span class="verse-text">${processVerseContent(element)}</span>`;
                        html += `</div>`;
                    }
                    break;
                    
                case 'lg':  // Line group (poetry)
                    html += `<div style="margin: 15px 0; padding-left: 20px;">`;
                    for (let child of element.children) {
                        if (child.nodeName === 'l') {
                            const level = child.getAttribute('level') || '1';
                            const indent = (parseInt(level) - 1) * 20;
                            html += `<div style="margin-left: ${indent}px;">${processOSISContent(child)}</div>`;
                        } else if (child.nodeName === 'head') {
                            html += `<div style="font-weight: bold; margin-bottom: 5px;">${child.textContent}</div>`;
                        }
                    }
                    html += `</div>`;
                    break;
                    
                case 'list':
                    html += `<div style="margin: 15px 0;">`;
                    for (let child of element.children) {
                        if (child.nodeName === 'head') {
                            html += `<div style="font-weight: bold; margin-bottom: 5px;">${child.textContent}</div>`;
                        } else if (child.nodeName === 'item') {
                            const label = child.querySelector('label');
                            if (label) {
                                html += `<div style="margin: 5px 0;"><strong>${label.textContent}</strong> ${processOSISContent(child)}</div>`;
                            } else {
                                html += `<div style="margin: 5px 0;">‚Ä¢ ${processOSISContent(child)}</div>`;
                            }
                        }
                    }
                    html += `</div>`;
                    break;
                    
                case 'div':
                    const divType = element.getAttribute('type') || '';
                    html += `<div style="margin: 15px 0;">`;
                    if (divType) {
                        html += `<div style="font-size: 0.9em; color: #999; margin-bottom: 5px;">[${divType}]</div>`;
                    }
                    for (let child of element.children) {
                        html += processChapterElement(child, chapterNum);
                    }
                    html += `</div>`;
                    break;
                    
                case 'q':
                    const qType = element.getAttribute('type') || '';
                    if (qType === 'block') {
                        html += `<blockquote style="margin: 15px 0; padding-left: 20px; border-left: 3px solid #ccc;">`;
                        for (let child of element.children) {
                            html += processChapterElement(child, chapterNum);
                        }
                        html += `</blockquote>`;
                    } else {
                        html += processOSISContent(element);
                    }
                    break;
                    
                case 'table':
                    html += `<table style="margin: 15px 0; border-collapse: collapse; width: 100%;">`;
                    for (let child of element.children) {
                        if (child.nodeName === 'head') {
                            html += `<caption style="font-weight: bold; margin-bottom: 5px;">${child.textContent}</caption>`;
                        } else if (child.nodeName === 'row') {
                            html += '<tr>';
                            for (let cell of child.children) {
                                const cellTag = cell.getAttribute('role') === 'label' ? 'th' : 'td';
                                html += `<${cellTag} style="border: 1px solid #ddd; padding: 8px;">${cell.textContent}</${cellTag}>`;
                            }
                            html += '</tr>';
                        }
                    }
                    html += `</table>`;
                    break;
                    
                case 'salute':
                    html += `<div style="margin: 15px 0; font-style: italic;">${element.textContent}</div>`;
                    break;
                    
                case 'signed':
                    html += `<div style="margin: 15px 0; text-align: right; font-style: italic;">‚Äî ${element.textContent}</div>`;
                    break;
                    
                case 'closer':
                    html += `<div style="margin: 20px 0; text-align: right;">`;
                    for (let child of element.children) {
                        html += processChapterElement(child, chapterNum);
                    }
                    html += `</div>`;
                    break;
                    
                case 'rdg':
                    const rdgType = element.getAttribute('type') || 'variant';
                    html += `<div style="margin: 10px 0; padding: 5px; background: #f9f9f9; border-left: 3px solid #999;">`;
                    html += `<small style="color: #666;">[${rdgType} reading]</small> ${element.textContent}`;
                    html += `</div>`;
                    break;
                    
                case 'castList':
                    html += `<div style="margin: 15px 0; border: 1px solid #ddd; padding: 10px; background: #fafafa;">`;
                    html += `<h4 style="margin: 0 0 10px 0; color: #666;">Cast List</h4>`;
                    for (let child of element.children) {
                        html += processChapterElement(child, chapterNum);
                    }
                    html += `</div>`;
                    break;
                    
                case 'castGroup':
                    html += `<div style="margin: 10px 0;">`;
                    for (let child of element.children) {
                        html += processChapterElement(child, chapterNum);
                    }
                    html += `</div>`;
                    break;
                    
                case 'castItem':
                    html += `<div style="margin: 5px 0; padding: 5px; border-left: 3px solid #ccc;">`;
                    for (let child of element.children) {
                        html += processChapterElement(child, chapterNum);
                    }
                    html += `</div>`;
                    break;
                    
                case 'actor':
                    html += `<span style="font-weight: bold; color: #333;">${element.textContent}</span> `;
                    break;
                    
                case 'role':
                    html += `<span style="font-style: italic; color: #666;">as ${element.textContent}</span> `;
                    break;
                    
                case 'roleDesc':
                    html += `<span style="font-size: 0.9em; color: #888;">(${element.textContent})</span>`;
                    break;
                    
                default:
                    // For any other elements, try to process their content
                    if (element.children.length > 0) {
                        for (let child of element.children) {
                            html += processChapterElement(child, chapterNum);
                        }
                    }
            }
            
            return html;
        }

        async function loadBook() {
            const select = document.getElementById('bookSelect');
            const content = document.getElementById('book-content');
            const selectedBook = select.value;

            if (!selectedBook) {
                content.innerHTML = '<div class="no-content">Select a book from the dropdown above to view the translation.</div>';
                return;
            }

            content.innerHTML = '<div class="no-content">Loading...</div>';

            try {
                const response = await fetch(books[selectedBook].file);
                if (!response.ok) {
                    throw new Error('File not found');
                }
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                displayBook(xmlDoc, books[selectedBook].title);
            } catch (error) {
                content.innerHTML = `<div class="no-content">Error loading ${books[selectedBook].title}: ${error.message}</div>`;
            }
        }

        function displayBook(xmlDoc, bookTitle) {
            const content = document.getElementById('book-content');
            let html = `<div class="book-title">${bookTitle}</div>`;
            
            // Display introduction if present
            const introduction = xmlDoc.querySelector('div[type="introduction"]');
            if (introduction) {
                html += `<div style="margin: 20px 30px; padding: 20px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 8px;">`;
                const introParas = introduction.querySelectorAll('p');
                introParas.forEach(para => {
                    html += `<p style="margin: 10px 0; line-height: 1.8; color: #2c3e50; font-size: 1.1em;">${para.textContent}</p>`;
                });
                html += `</div>`;
            }
            
            // Display cast list from header if present
            const castList = xmlDoc.querySelector('header castList');
            if (castList) {
                html += `<div style="margin: 20px 0; border: 1px solid #ddd; padding: 15px; background: #fafafa;">`;
                html += `<h3 style="margin: 0 0 10px 0; color: #333;">Cast of Characters</h3>`;
                const castGroups = castList.querySelectorAll('castGroup');
                castGroups.forEach(group => {
                    const castItems = group.querySelectorAll('castItem');
                    castItems.forEach(item => {
                        const actor = item.querySelector('actor');
                        const role = item.querySelector('role');
                        const roleDesc = item.querySelector('roleDesc');
                        
                        html += `<div style="margin: 8px 0; padding: 5px; border-left: 3px solid #667eea;">`;
                        if (actor) html += `<strong>${actor.textContent}</strong>`;
                        if (role) html += ` <em>as ${role.textContent}</em>`;
                        if (roleDesc) html += ` <span style="color: #666;">(${roleDesc.textContent})</span>`;
                        html += `</div>`;
                    });
                });
                html += `</div>`;
            }

            // Handle three different OSIS chapter formats:
            // 1. <div type="chapter"> (Daniel format)
            // 2. <chapter osisID="...">...</chapter> (Container format - Genesis 1-19)  
            // 3. <chapter osisID="..." sID="..."/>...<chapter eID="..."/> (Milestone format - Genesis 20+)
            
            // First, handle div type="chapter" format
            const divChapters = xmlDoc.querySelectorAll('div[type="chapter"]');
            
            if (divChapters.length > 0) {
                // Process div chapters
                divChapters.forEach(chapter => {
                    let chapterTitle = chapter.querySelector('title[type="chapter"]');
                    if (!chapterTitle) {
                        chapterTitle = chapter.querySelector('title');
                    }
                    
                    if (chapterTitle) {
                        html += `<div class="chapter">`;
                        html += `<div class="chapter-title">${chapterTitle.textContent}</div>`;
                    }

                    const verses = chapter.querySelectorAll('verse[osisID]');
                    verses.forEach(verse => {
                        const verseId = verse.getAttribute('osisID');
                        const verseNum = verseId.split('.').pop();
                        
                        html += `<div class="verse">`;
                        html += `<span class="verse-number">${verseNum}</span>`;
                        html += `<span class="verse-text">${processVerseContent(verse)}</span>`;
                        html += `</div>`;
                    });

                    html += `</div>`;
                });
            } else {
                // Handle both container and milestone chapter formats together
                // First process container chapters
                const containerChapters = xmlDoc.querySelectorAll('chapter[osisID]:not([sID]):not([eID])');
                
                containerChapters.forEach(chapter => {
                    const chapterNum = chapter.getAttribute('osisID').split('.').pop();
                    html += `<div class="chapter">`;
                    
                    // Process all children of the chapter in order, handling both container and milestone verses
                    const children = Array.from(chapter.children);
                    for (let i = 0; i < children.length; i++) {
                        const child = children[i];
                        
                        // Special handling for milestone verses within container chapters
                        if (child.nodeName === 'verse' && child.getAttribute('sID')) {
                            html += processMilestoneVerseInContainer(child, i, children);
                            // Skip ahead past the end marker
                            const verseEndId = child.getAttribute('sID');
                            while (i < children.length && !(children[i].nodeName === 'verse' && children[i].getAttribute('eID') === verseEndId)) {
                                i++;
                            }
                        } else if (child.nodeName === 'verse' && child.getAttribute('eID')) {
                            // Skip verse end markers - already handled above
                            continue;
                        } else {
                            html += processChapterElement(child, chapterNum);
                        }
                    }

                    html += `</div>`;
                });
                
                // Process milestone chapters with titles in order
                const milestoneStarts = xmlDoc.querySelectorAll('chapter[sID]');
                
                milestoneStarts.forEach(chapterStart => {
                    const chapterOsisId = chapterStart.getAttribute('osisID');
                    const chapterNum = chapterOsisId.split('.').pop();
                    
                    html += `<div class="chapter">`;
                    html += `<div class="chapter-title">Chapter ${chapterNum}</div>`;
                    
                    // Find all elements between this chapter start and its end
                    let currentElement = chapterStart.nextElementSibling;
                    const chapterEndId = chapterOsisId;
                    
                    while (currentElement && !(currentElement.nodeName === 'chapter' && currentElement.getAttribute('eID') === chapterEndId)) {
                        // Special handling for milestone verses
                        if (currentElement.nodeName === 'verse' && currentElement.getAttribute('sID')) {
                            html += processMilestoneVerse(currentElement, currentElement.nextSibling);
                            // Skip ahead to after the verse end marker
                            const verseEndId = currentElement.getAttribute('sID');
                            while (currentElement && !(currentElement.nodeName === 'verse' && currentElement.getAttribute('eID') === verseEndId)) {
                                currentElement = currentElement.nextElementSibling || currentElement.nextSibling;
                                if (!currentElement) break;
                            }
                            if (currentElement && currentElement.getAttribute('eID') === verseEndId) {
                                currentElement = currentElement.nextElementSibling;
                            }
                            continue;
                        }
                        
                        html += processChapterElement(currentElement, chapterNum);
                        currentElement = currentElement.nextElementSibling;
                    }
                    
                    html += `</div>`;
                });
            }

            content.innerHTML = html;
        }
    </script>
</body>
</html>